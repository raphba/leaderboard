<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
/* [GLEICHE STYLES WIE VORHER - ZU LANG F√úR HIER] */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: Arial, Helvetica, sans-serif;
  background: #160e05;
  padding: 40px 20px;
  color: #fff;
}

.container {
  max-width: 900px;
  margin: 0 auto;
}

.header {
  text-align: center;
  margin-bottom: 40px;
}

.header h1 {
  font-family: Impact, sans-serif;
  font-size: 56px;
  font-weight: normal;
  text-transform: uppercase;
  letter-spacing: 4px;
  color: #ceb77f;
  text-shadow: 3px 3px 8px rgba(0,0,0,0.8);
  margin-bottom: 15px;
  border: 4px solid #ceb77f;
  border-radius: 50px;
  padding: 20px 40px;
  background: #4a2e22;
  display: inline-block;
}

.loading {
  text-align: center;
  font-size: 20px;
  padding: 60px;
  color: #ceb77f;
  font-weight: 600;
}

.error {
  background: #ceb77f;
  padding: 40px;
  border-radius: 20px;
  text-align: center;
  color: #160e05;
  font-weight: 700;
  font-size: 18px;
  border: 4px solid #4a2e22;
}

.refresh-btn {
  background: #ceb77f;
  border: 3px solid #4a2e22;
  color: #160e05;
  padding: 15px 40px;
  font-size: 18px;
  font-weight: 800;
  border-radius: 30px;
  cursor: pointer;
  margin-bottom: 30px;
  text-transform: uppercase;
}

/* [REST DER STYLES...] */
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>üèÜ RANGLISTE</h1>
  </div>
  
  <center>
    <button class="refresh-btn" onclick="requestData()">üîÑ Laden</button>
  </center>
  
  <div id="content">
    <div class="loading">‚è≥ Warte auf Daten von Storyline...</div>
  </div>
</div>

<script>
console.log("=== LEADERBOARD (POSTMESSAGE) START ===");

var receivedData = null;

// EMPFANGE Daten von Storyline
window.addEventListener('message', function(event) {
  console.log("Message received:", event.data);
  
  if (event.data && event.data.type === 'LEADERBOARD_DATA') {
    receivedData = event.data;
    loadLeaderboard(event.data);
  }
});

// FORDERE Daten an
function requestData() {
  console.log("Requesting data from Storyline...");
  window.parent.postMessage({ type: 'REQUEST_LEADERBOARD_DATA' }, '*');
  
  document.getElementById('content').innerHTML = '<div class="loading">‚è≥ Lade Daten...</div>';
}

function loadLeaderboard(data) {
  console.log("=== LOAD LEADERBOARD ===");
  console.log("Data:", data);
  
  var content = document.getElementById('content');
  
  var userName = data.userName;
  var apiURL = data.apiURL;
  var m1 = data.m1 || 0;
  var m2 = data.m2 || 0;
  var m3 = data.m3 || 0;
  
  console.log("UserName:", userName);
  console.log("API:", apiURL);
  console.log("Missions:", m1, m2, m3);
  
  if (!userName || !apiURL) {
    content.innerHTML = '<div class="error">‚ùå Fehlende Daten!</div>';
    return;
  }
  
  content.innerHTML = '<div class="loading">‚è≥ Lade Rangliste von API...</div>';
  
  var timestamp = new Date().getTime();
  var callbackName = 'leaderboardCallback_' + timestamp;
  var url = apiURL + '?callback=' + callbackName + '&nocache=' + timestamp;
  
  console.log("JSONP URL:", url);
  
  window[callbackName] = function(result) {
    console.log("API Response:", result);
    
    try {
      if (!result.success) throw new Error(result.message);
      
      var apiData = result.data;
      var totalParticipants = apiData.length;
      
      var userIndex = -1;
      var userEntry = null;
      
      for (var i = 0; i < apiData.length; i++) {
        if (apiData[i].name === userName) {
          userIndex = i;
          userEntry = apiData[i];
          break;
        }
      }
      
      if (!userEntry) {
        content.innerHTML = '<div class="error">‚ùå Ihre Daten wurden noch nicht gefunden!</div>';
        return;
      }
      
      var userRank = userIndex + 1;
      var percentile = Math.round((userIndex / totalParticipants) * 100);
      
      // HIER DEN HTML AUFBAU WIE VORHER...
      content.innerHTML = '<div style="color: #ceb77f; text-align: center; padding: 40px;">' +
        '<h2 style="font-size: 32px; margin-bottom: 20px;">Platz #' + userRank + ' von ' + totalParticipants + '</h2>' +
        '<p style="font-size: 48px; font-family: Impact;">' + userEntry.totalPoints + ' Punkte</p>' +
        '</div>';
      
      console.log("‚úÖ LEADERBOARD LOADED!");
      
    } catch (error) {
      console.error("Error:", error);
      content.innerHTML = '<div class="error">‚ùå Fehler: ' + error.message + '</div>';
    }
    
    try {
      delete window[callbackName];
    } catch (e) {}
  };
  
  var script = document.createElement('script');
  script.src = url;
  document.head.appendChild(script);
}

// Auto-request beim Laden
setTimeout(requestData, 1000);

console.log("=== LEADERBOARD READY ===");
</script>

</body>
</html>
