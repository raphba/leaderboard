<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: Arial, Helvetica, sans-serif;
  background: #160e05;
  padding: 40px 20px;
  color: #fff;
}

.container {
  max-width: 900px;
  margin: 0 auto;
}

.header {
  text-align: center;
  margin-bottom: 40px;
}

.header h1 {
  font-family: Impact, sans-serif;
  font-size: 56px;
  font-weight: normal;
  text-transform: uppercase;
  letter-spacing: 4px;
  color: #ceb77f;
  text-shadow: 3px 3px 8px rgba(0,0,0,0.8);
  margin-bottom: 15px;
  border: 4px solid #ceb77f;
  border-radius: 50px;
  padding: 20px 40px;
  background: #4a2e22;
  display: inline-block;
}

.header p {
  font-size: 18px;
  color: #ceb77f;
  font-weight: 600;
  margin-top: 15px;
}

.refresh-btn {
  background: #ceb77f;
  border: 3px solid #4a2e22;
  color: #160e05;
  padding: 15px 40px;
  font-size: 18px;
  font-weight: 800;
  border-radius: 30px;
  cursor: pointer;
  font-family: Arial, sans-serif;
  transition: all 0.3s;
  margin-bottom: 30px;
  text-transform: uppercase;
  letter-spacing: 2px;
}

.refresh-btn:hover {
  background: #fff;
  transform: scale(1.05);
}

.loading {
  text-align: center;
  font-size: 20px;
  padding: 60px;
  color: #ceb77f;
  font-weight: 600;
}

.leaderboard {
  background: linear-gradient(180deg, #ceb77f 0%, #d4c08f 100%);
  border-radius: 30px;
  overflow: hidden;
  box-shadow: 0 15px 50px rgba(0,0,0,0.6);
  border: 5px solid #4a2e22;
}

.top5-section {
  padding: 35px 30px;
  background: linear-gradient(180deg, #ceb77f 0%, #d4c08f 50%, #ceb77f 100%);
}

.section-title {
  font-family: Impact, sans-serif;
  font-weight: normal;
  font-size: 32px;
  color: #160e05;
  margin-bottom: 25px;
  text-transform: uppercase;
  letter-spacing: 3px;
  text-align: center;
  padding-bottom: 15px;
  border-bottom: 3px solid #4a2e22;
}

.rank-item {
  display: flex;
  align-items: center;
  padding: 18px 20px;
  margin-bottom: 12px;
  background: linear-gradient(135deg, #4a2e22 0%, #3a2018 100%);
  border-radius: 15px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  transition: all 0.3s;
  border: 2px solid #ceb77f;
}

.rank-item:hover {
  transform: translateX(8px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.6);
  border-color: #fff;
}

.rank-medal {
  font-size: 40px;
  width: 60px;
  text-align: center;
}

.rank-number {
  font-family: Impact, sans-serif;
  font-weight: normal;
  font-size: 40px;
  width: 60px;
  text-align: center;
  color: #ceb77f;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
}

.rank-info {
  flex: 1;
  padding: 0 20px;
}

.rank-name {
  font-weight: 700;
  font-size: 20px;
  color: #ceb77f;
  margin-bottom: 5px;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.rank-anonymous {
  color: #999;
  font-style: italic;
}

.rank-points {
  font-family: Impact, sans-serif;
  font-weight: normal;
  font-size: 28px;
  color: #fff;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
}

.user-section {
  padding: 35px 30px;
  background: #4a2e22;
  border-top: 5px solid #160e05;
}

.user-label {
  font-family: Impact, sans-serif;
  font-weight: normal;
  font-size: 24px;
  color: #ceb77f;
  text-transform: uppercase;
  letter-spacing: 2px;
  text-align: center;
  margin-bottom: 20px;
}

.user-card {
  background: linear-gradient(135deg, #ceb77f 0%, #d4c08f 100%);
  border-radius: 20px;
  padding: 25px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.5);
  border: 3px solid #160e05;
}

.user-header {
  display: flex;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 3px solid #4a2e22;
}

.user-icon {
  font-size: 50px;
  margin-right: 20px;
}

.user-name {
  font-family: Impact, sans-serif;
  font-weight: normal;
  font-size: 32px;
  color: #160e05;
  text-transform: uppercase;
  letter-spacing: 2px;
}

.user-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
  margin-top: 15px;
}

.stat {
  text-align: center;
  background: #4a2e22;
  padding: 15px;
  border-radius: 12px;
  border: 2px solid #160e05;
}

.stat-label {
  font-size: 14px;
  color: #ceb77f;
  text-transform: uppercase;
  margin-bottom: 8px;
  font-weight: 700;
  letter-spacing: 1px;
}

.stat-value {
  font-family: Impact, sans-serif;
  font-weight: normal;
  font-size: 36px;
  color: #fff;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
}

.motivation {
  margin-top: 20px;
  padding: 20px;
  background: #160e05;
  border-radius: 15px;
  color: #ceb77f;
  text-align: center;
  font-weight: 700;
  font-size: 18px;
  line-height: 1.6;
  border: 3px solid #4a2e22;
}

.error {
  background: #ceb77f;
  padding: 40px;
  border-radius: 20px;
  text-align: center;
  color: #160e05;
  font-weight: 700;
  font-size: 18px;
  border: 4px solid #4a2e22;
}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>üèÜ RANGLISTE</h1>
    <p>Ihre Position im Vergleich zu anderen Teilnehmern</p>
  </div>
  
  <center>
    <button class="refresh-btn" onclick="loadLeaderboard()">üîÑ Aktualisieren</button>
  </center>
  
  <div id="content">
    <div class="loading">‚è≥ Lade Rangliste...</div>
  </div>
</div>

<script>
console.log("=== LEADERBOARD (URL PARAMS) START ===");

function getUrlParams() {
  var params = {};
  var search = window.location.search.substring(1);
  if (search) {
    var pairs = search.split('&');
    for (var i = 0; i < pairs.length; i++) {
      var pair = pairs[i].split('=');
      params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || '');
    }
  }
  return params;
}

function loadLeaderboard() {
  console.log("=== LOAD LEADERBOARD ===");
  
  var content = document.getElementById('content');
  var params = getUrlParams();
  
  console.log("URL Params:", params);
  
  var currentUserName = params.user || "";
  var apiURL = params.api || "https://script.google.com/macros/s/AKfycbzFpfjkuC3YbTq2_8vOrRLqrPfMhszVod63fpXwm1llhF7cjcndZogIvAtvdl3b_S_8Fw/exec";
  var m1 = parseInt(params.m1) || 0;
  var m2 = parseInt(params.m2) || 0;
  var m3 = parseInt(params.m3) || 0;
  
  console.log("UserName:", currentUserName);
  console.log("API:", apiURL);
  console.log("Missions:", m1, m2, m3);
  
  if (!currentUserName) {
    content.innerHTML = '<div class="error">‚ùå Kein Benutzername √ºbergeben!</div>';
    return;
  }
  
  content.innerHTML = '<div class="loading">‚è≥ Lade Rangliste...</div>';
  
  var timestamp = new Date().getTime();
  var callbackName = 'leaderboardCallback_' + timestamp;
  var url = apiURL + '?callback=' + callbackName + '&nocache=' + timestamp;
  
  console.log("JSONP URL:", url);
  
  window[callbackName] = function(result) {
    console.log("Response:", result);
    
    try {
      if (!result.success) throw new Error(result.message);
      
      var data = result.data;
      var totalParticipants = data.length;
      
      console.log("Participants:", totalParticipants);
      
      var userIndex = -1;
      var userEntry = null;
      
      for (var i = 0; i < data.length; i++) {
        if (data[i].name === currentUserName) {
          userIndex = i;
          userEntry = data[i];
          break;
        }
      }
      
      if (!userEntry) {
        content.innerHTML = '<div class="error">‚ùå Ihre Daten wurden noch nicht gefunden.<br>Bitte absolvieren Sie zuerst eine Mission!</div>';
        return;
      }
      
      var userRank = userIndex + 1;
      var percentile = Math.round((userIndex / totalParticipants) * 100);
      
      console.log("Rank:", userRank, "Percentile:", percentile);
      
      var motivationText = generateMotivation(percentile, userRank, totalParticipants, m1, m2, m3);
      
      var html = '<div class="leaderboard">';
      
      html += '<div class="top5-section">';
      html += '<div class="section-title">üèÖ Top 5 Teilnehmer</div>';
      
      for (var i = 0; i < 5 && i < data.length; i++) {
        var entry = data[i];
        var isCurrentUser = (entry.name === currentUserName);
        var displayName = isCurrentUser ? "Sie" : "Teilnehmer";
        var nameClass = isCurrentUser ? "rank-name" : "rank-name rank-anonymous";
        var medal = ['ü•á', 'ü•à', 'ü•â', '4', '5'][i];
        var isMedal = i < 3;
        
        html += '<div class="rank-item">';
        if (isMedal) {
          html += '<div class="rank-medal">' + medal + '</div>';
        } else {
          html += '<div class="rank-number">' + medal + '</div>';
        }
        html += '<div class="rank-info">';
        html += '<div class="' + nameClass + '">' + displayName + '</div>';
        html += '</div>';
        html += '<div class="rank-points">' + entry.totalPoints.toLocaleString() + ' Punkte</div>';
        html += '</div>';
      }
      
      html += '</div>';
      
      html += '<div class="user-section">';
      html += '<div class="user-label">üìä Ihre Position</div>';
      html += '<div class="user-card">';
      html += '<div class="user-header">';
      html += '<div class="user-icon">üë§</div>';
      html += '<div class="user-name">Sie</div>';
      html += '</div>';
      
      html += '<div class="user-stats">';
      html += '<div class="stat">';
      html += '<div class="stat-label">Platz</div>';
      html += '<div class="stat-value">#' + userRank + '</div>';
      html += '</div>';
      html += '<div class="stat">';
      html += '<div class="stat-label">Punkte</div>';
      html += '<div class="stat-value">' + userEntry.totalPoints.toLocaleString() + '</div>';
      html += '</div>';
      html += '<div class="stat">';
      html += '<div class="stat-label">Von</div>';
      html += '<div class="stat-value">' + totalParticipants + '</div>';
      html += '</div>';
      html += '</div>';
      
      html += '<div class="motivation">' + motivationText + '</div>';
      html += '</div>';
      html += '</div>';
      html += '</div>';
      
      content.innerHTML = html;
      
      console.log("‚úÖ LEADERBOARD LOADED!");
      
    } catch (error) {
      console.error("Error:", error);
      content.innerHTML = '<div class="error">‚ùå Fehler: ' + error.message + '</div>';
    }
    
    try {
      delete window[callbackName];
      if (script && script.parentNode) document.head.removeChild(script);
    } catch (e) {}
  };
  
  var script = document.createElement('script');
  script.src = url;
  script.onerror = function() {
    console.error("JSONP failed!");
    content.innerHTML = '<div class="error">‚ùå Verbindung fehlgeschlagen!</div>';
    try { delete window[callbackName]; } catch (e) {}
  };
  
  document.head.appendChild(script);
}

function generateMotivation(percentile, rank, total, m1, m2, m3) {
  if (rank === 1) {
    return "üéâ Hervorragend! Sie sind auf Platz 1 von " + total + " Teilnehmern! Ihre Sicherheitskompetenz ist beispielhaft!";
  } 
  
  if (rank <= 3) {
    return "üèÜ Gro√üartig! Sie sind auf dem Podium (Platz " + rank + " von " + total + ")! Sie haben ein ausgezeichnetes Sicherheitsbewusstsein bewiesen!";
  } 
  
  if (percentile <= 10) {
    return "‚≠ê Sehr gut! Sie geh√∂ren zu den besten 10% der Teilnehmer! Ihr Wissen im Bereich IT-Sicherheit ist √ºberdurchschnittlich stark ausgepr√§gt!";
  } 
  
  if (percentile <= 25) {
    var betterThan = 100 - percentile;
    return "üìà Gut gemacht! Sie sind in den Top 25% und haben " + betterThan + "% der Teilnehmer √ºbertroffen. Sie zeigen ein solides Sicherheitsbewusstsein!";
  } 
  
  if (percentile <= 50) {
    var betterThan = 100 - percentile;
    return "üí™ Respektable Leistung! Sie sind besser als " + betterThan + "% der Teilnehmer. Sie haben bereits eine gute Grundlage im Bereich IT-Sicherheit!";
  }
  
  var weakAreas = [];
  var maxPoints = 200;
  var threshold = maxPoints * 0.6;
  
  if (m1 > 0 && m1 < threshold) weakAreas.push("Ger√§tesicherheit");
  if (m2 > 0 && m2 < threshold) weakAreas.push("WLAN-Sicherheit");
  if (m3 > 0 && m3 < threshold) weakAreas.push("Phishing-Erkennung");
  
  var message = "üéØ Sie haben Potenzial nach oben! ";
  
  if (weakAreas.length === 0) {
    message += "Vertiefen Sie Ihr Wissen in allen Bereichen der IT-Sicherheit, um Ihre Position zu verbessern. Besonders die Themen Ger√§tesicherheit, WLAN-Sicherheit und Phishing-Erkennung sind im Arbeitsalltag von gro√üer Bedeutung.";
  } else if (weakAreas.length === 1) {
    message += "Besonders im Bereich " + weakAreas[0] + " k√∂nnen Sie Ihr Wissen noch vertiefen, um Ihre Sicherheitskompetenz zu st√§rken.";
  } else if (weakAreas.length === 2) {
    message += "Besonders in den Bereichen " + weakAreas[0] + " und " + weakAreas[1] + " k√∂nnen Sie Ihr Wissen noch vertiefen, um Ihre Sicherheitskompetenz zu st√§rken.";
  } else {
    message += "Besonders in den Bereichen " + weakAreas[0] + ", " + weakAreas[1] + " und " + weakAreas[2] + " k√∂nnen Sie Ihr Wissen noch vertiefen, um Ihre Sicherheitskompetenz zu st√§rken.";
  }
  
  return message;
}

setTimeout(loadLeaderboard, 500);

console.log("=== LEADERBOARD READY ===");
</script>

</body>
</html>
